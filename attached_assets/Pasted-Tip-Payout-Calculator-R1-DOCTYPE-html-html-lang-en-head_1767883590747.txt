Tip Payout Calculator R1

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Erwin Mills Tip Calculator</title>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
/* MAIN PAGE STYLES */
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 15px;
  background: white;
  color: black;
  min-height: 100vh;
}
.container { max-width: 900px; margin: auto; }

/* HEADERS & BRANDING */
.company-name {
  text-align: center;
  color: #132a1f; /* Erwin Mills Green */
  font-size: 2.2em;
  font-weight: bold;
  margin-top: 10px;
  margin-bottom: 5px;
  text-transform: uppercase;
  letter-spacing: 1px;
}
h1 { text-align: center; color: black; margin: 5px 0 20px; font-size: 1.5em; font-weight: normal; }
h2 { text-align: center; color: black; margin: 10px 0; font-size: 1.8em; }

/* CARDS */
.card {
  background: #f8f8f8;
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  border: 2px solid #efbb41;
  color: black;
}

/* INPUTS & BUTTONS */
input, select, button {
  padding: 12px;
  margin: 8px 0;
  font-size: 16px;
  border-radius: 6px;
  border: 1px solid #efbb41;
  background: #fff;
  color: black;
  width: 100%;
  box-sizing: border-box;
}

/* SPECIFIC FIX: Make the date picker smaller and centered */
#weekPicker {
    max-width: 300px; 
    display: inline-block;
}

button { background: #efbb41; color: #132a1f; border: none; font-weight: bold; cursor: pointer; }
button:hover { background: #f0c860; }

/* NEW EXPORT BUTTON STYLING: Constrains width and centers them */
.export-controls button {
    max-width: 300px; /* Set a consistent max width */
    display: block;  /* Ensures margin: auto works for centering */
    margin: 10px auto; /* Centers the button horizontally */
}

/* TABLE STYLES (FORCE BLACK TEXT) */
table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 1em; }
th, td {
  padding: 10px;
  text-align: left;
  border-bottom: 1px solid #efbb41;
  color: #000000 !important; /* Force Black */
}
th {
  background: #fef3e2;
  color: #000000 !important;
}
tr { background-color: #ffffff; }

/* NEW STYLE FOR RATE SUMMARY */
.rate-summary {
    margin: 10px 0 20px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    background: #fff;
}
.rate-summary p {
    margin: 5px 0;
    font-size: 1.1em;
    color: #132a1f;
}

.row { display: flex; gap: 10px; flex-wrap: wrap; }
.col { flex: 1; min-width: 280px; }
.success { color: #27ae60; font-weight: bold; text-align: center; }
.warning { color: #e74c3c; font-weight: bold; text-align: center; }
.week-info { background: #fef3e2; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #efbb41; color: #132a1f; }

@media(max-width: 600px) {
  .company-name { font-size: 1.8em; }
  h1, h2 { font-size: 1.4em; }
  input, select, button { font-size: 18px; padding: 14px; }
}
</style>
</head>
<body>

<div class="container">
  <div class="company-name">Erwin Mills Coffee Company</div>
  <h1>Tip Calculator</h1>

  <div class="card week-info">
    <strong>Week: Monday <span id="weekStart"></span> â€“ Sunday <span id="weekEnd"></span></strong><br>
    <input type="date" id="weekPicker" onchange="changeWeek()">
  </div>

  <div class="card"><h2>Add New Employee</h2><input id="newEmployee" placeholder="Exact name"><button onclick="addEmployee()">Add</button><div id="employeeMsg" class="success"></div></div>

  <div class="card"><h2>Total Tips This Week</h2>
    <div class="row"><div class="col"><input id="cashTips" placeholder="Cash Tips ($)" step="0.01"></div><div class="col"><input id="ccTips" placeholder="Credit Card Tips ($)" step="0.01"></div></div>
    <button onclick="saveWeeklyTips()">Save Tips</button><div id="tipsMsg" class="success"></div>
  </div>

  <div class="card"><h2>Enter Hours</h2>
    <select id="employeeSelect"></select>
    <div class="row"><div class="col"><input id="hoursWhole" placeholder="Hours" min="0"></div><div class="col"><input id="minutesInput" placeholder="Minutes (0-59)" min="0" max="59"></div></div>
    <button onclick="addHours()">Add Hours</button><div id="hoursMsg" class="success"></div>
  </div>

  <div class="card"><h2>Total Team Hours Check</h2>
    <div class="row"><div class="col"><input id="teamHoursWhole" placeholder="Total Team Hours" min="0"></div><div class="col"><input id="teamMinutes" placeholder="Total Team Minutes" min="0" max="59"></div></div>
    <button onclick="checkTeamHours()">Verify</button><div id="teamHoursCheck" class="success"></div>
  </div>

  <div class="card" id="printArea">
    <h2>Payout Summary â€“ <br><span id="summaryWeek"></span></h2>
    <div id="summary"></div>
  </div>
  
  <div class="card export-controls" style="text-align: center; padding: 10px 20px;">
    <h2>Export & Data Management</h2>
    <div><button onclick="exportToCSV()">Export CSV</button></div>
    <div><button onclick="exportToPDF()">Export PDF</button></div>
    <div style="margin-top: 10px;">
        <button onclick="clearLocalStorage()">Clear All Saved Data</button>
    </div>
  </div>
</div>

<script>
// --- DATA & UTILS ---
const KEY='ErwinMills_FinalPDFWorking';
let d=localStorage.getItem(KEY)?JSON.parse(localStorage.getItem(KEY)):{employees:[],weeks:{}};
function save(){localStorage.setItem(KEY,JSON.stringify(d));}
function monday(t=new Date()){let e=new Date(t);return new Date(e.setDate(e.getDate()-e.getDay()+(e.getDay()===0?-6:1)));}
function weekKey(s){return monday(s||new Date()).toISOString().split('T')[0];}
function range(k){let m=new Date(k),s=new Date(m);s.setDate(m.getDate()+6);return m.toLocaleDateString()+' â€“ '+s.toLocaleDateString();}
function hm(v){let h=Math.floor(v),m=Math.round((v-h)*60);return h+'h '+(m<10?'0':'')+m+'m';}

// --- INITIALIZATION ---
function init(){document.getElementById('weekPicker').value=monday().toISOString().split('T')[0];refresh();changeWeek();}

// --- EMPLOYEES ---
function refresh(){let s=document.getElementById('employeeSelect');s.innerHTML='<option value="">Select Employee</option>';d.employees.sort().forEach(n=>{let o=document.createElement('option');o.value=o.textContent=n;s.appendChild(o)});}
function addEmployee(){let n=document.getElementById('newEmployee').value.trim();if(!n)return alert('Enter name');if(d.employees.includes(n))return alert('Exists');d.employees.push(n);save();refresh();document.getElementById('newEmployee').value='';document.getElementById('employeeMsg').textContent=n+' added!';setTimeout(()=>document.getElementById('employeeMsg').textContent='',3000);}

// --- WEEK & DATA HANDLING ---
function changeWeek(){let k=weekKey(document.getElementById('weekPicker').value);let m=new Date(k),s=new Date(m);s.setDate(m.getDate()+6);document.getElementById('weekStart').textContent=m.toLocaleDateString();document.getElementById('weekEnd').textContent=s.toLocaleDateString();document.getElementById('summaryWeek').textContent=range(k);showSummary();}
function saveWeeklyTips(){let cash=+document.getElementById('cashTips').value||0,cc=+document.getElementById('ccTips').value||0;if(cash+cc===0)return alert('Enter tips');let k=weekKey();if(!d.weeks[k])d.weeks[k]={hours:{}};d.weeks[k].cash=cash;d.weeks[k].cc=cc;save();document.getElementById('tipsMsg').textContent='Tips saved!';setTimeout(()=>document.getElementById('tipsMsg').textContent='',3000);document.getElementById('cashTips').value=document.getElementById('ccTips').value='';showSummary();}
function addHours(){let e=document.getElementById('employeeSelect').value,h=+document.getElementById('hoursWhole').value||0,m=+document.getElementById('minutesInput').value||0;if(!e)return alert('Select employee');if(h===0&&m===0)return alert('Enter time');if(m>59)m=59;let v=h+m/60,k=weekKey();if(!d.weeks[k])d.weeks[k]={hours:{}};d.weeks[k].hours[e]=v;save();document.getElementById('hoursMsg').textContent=e+': '+hm(v)+' saved';setTimeout(()=>document.getElementById('hoursMsg').textContent='',3000);document.getElementById('hoursWhole').value=document.getElementById('minutesInput').value='';showSummary();}
function checkTeamHours(){let h=+document.getElementById('teamHoursWhole').value||0,m=+document.getElementById('teamMinutes').value||0;if(m>59)m=59;let dec=h+m/60,k=weekKey(),w=d.weeks[k]||{hours:{}},act=Object.values(w.hours).reduce((a,b)=>a+b,0),diff=Math.abs(act-dec),msg=document.getElementById('teamHoursCheck');msg.style.color=diff<0.1?'#27ae60':'#e74c3c';msg.textContent=diff<0.1?`Perfect! ${hm(act)}`:`Warning: Entered ${hm(act)} vs declared ${hm(dec)} (diff ${diff.toFixed(2)}h)`;}

// --- DISPLAY ---
function showSummary(){
    let k=weekKey(),
        w=d.weeks[k]||{cash:0,cc:0,hours:{}},
        pool=(w.cash||0)+(w.cc||0)*0.965, // 96.5% after 3.5% CC fee
        totalH=Object.values(w.hours).reduce((a,b)=>a+b,0),
        rate=totalH>0?pool/totalH:0;

    let summaryHtml = '';
    
    // Hourly Rate Summary
    summaryHtml += `
        <div class="rate-summary">
            <p><strong>Total Tips (After CC Fee):</strong> $${pool.toFixed(2)}</p>
            <p><strong>Total Team Hours:</strong> ${hm(totalH)} (${totalH.toFixed(2)}h)</p>
            <p>ðŸ’° <strong>Calculated Hourly Rate:</strong> $${rate.toFixed(2)}</p>
        </div>
    `;

    // Payout Table
    summaryHtml += `<table><tr><th>Employee</th><th>Hours</th><th>Payout</th></tr>`;
    
    // Employee Rows
    Object.entries(w.hours)
        .sort(([a],[b])=>a.localeCompare(b))
        .forEach(([e,h])=>summaryHtml+=`<tr><td>${e}</td><td>${hm(h)}</td><td>$${(h*rate).toFixed(2)}</td></tr>`);
    
    // Total Row
    summaryHtml += `<tr style="background:#fef3e2;font-weight:bold;color:black !important;">
                        <td colspan="2" style="color:black !important;">Total Paid Out</td>
                        <td style="color:black !important;">$${pool.toFixed(2)}</td>
                    </tr></table>`;
                    
    document.getElementById('summary').innerHTML = summaryHtml;
}

// --- EXPORT FUNCTIONS ---
function exportToCSV(){
    let k=weekKey(),
        w=d.weeks[k]||{cash:0,cc:0,hours:{}},
        pool=(w.cash||0)+(w.cc||0)*0.965, // 96.5% after 3.5% CC fee
        totalH=Object.values(w.hours).reduce((a,b)=>a+b,0),
        rate=totalH>0?pool/totalH:0;

    // 1. Start CSV with the Week Range
    let csv=`Week: ${range(k)}\n\n`; // Two newlines for separation

    // 2. Add the main table header
    csv+="Employee,Hours (h:m),Hourly Rate ($/hr),Payout\n";
    
    // 3. Add employee data rows
    Object.entries(w.hours)
        .sort(([a],[b])=>a.localeCompare(b))
        .forEach(([e,h])=>
            csv+=`"${e}","${hm(h)}",${rate.toFixed(2)},${(h*rate).toFixed(2)}\n`
        );
    
    // 4. Add the Total Pool summary at the end
    csv+=`\nTotal Tip Pool,,,${pool.toFixed(2)}\n`; 
    
    let b=new Blob([csv],{type:'text/csv'}),
        l=document.createElement('a'),
        u=URL.createObjectURL(b);
        
    l.href=u;
    l.download=`Tips_${k}.csv`;
    l.click();
}

function exportToPDF(){
    if(!window.html2canvas || !window.jspdf) {
        alert("Export libraries not loaded. Please check connection.");
        return;
    }
    
    const printArea = document.getElementById('printArea');

    // Use a fixed scale for clear rendering
    html2canvas(printArea, { scale: 2, useCORS: false }).then(c => {
        const jsPDF = window.jspdf.jsPDF;
        const p = new jsPDF('p', 'mm', 'a4');
        const A4_HEIGHT_MM = 297; 
        const A4_WIDTH_MM = 210;
        const margin_mm = 10;
        const printable_height_mm = A4_HEIGHT_MM - 2 * margin_mm;
        const printable_width_mm = A4_WIDTH_MM - 2 * margin_mm;
        
        // Calculate the height of the content in the PDF's scale (pixels / 2 for html2canvas scale=2)
        const contentHeight_px = c.height / 2;
        const contentWidth_px = c.width / 2;
        
        // Convert content height from pixels (at scale 1) to millimeters
        const pixelsPerMM = contentWidth_px / printable_width_mm;
        const contentHeight_mm = contentHeight_px / pixelsPerMM;
        
        let scaleFactor = 1.0;
        
        // Check if content exceeds the printable height
        if (contentHeight_mm > printable_height_mm) {
            // Calculate the scaling factor needed to fit content onto one page
            scaleFactor = printable_height_mm / contentHeight_mm;
        }

        // Apply scaling to image dimensions
        const finalWidth = printable_width_mm * scaleFactor;
        const finalHeight = contentHeight_mm * scaleFactor;

        p.addImage(c.toDataURL('image/png'), 'PNG', margin_mm, margin_mm, finalWidth, finalHeight);
        p.save(`ErwinMills_Tips_${weekKey()}.pdf`);
    }).catch(e => alert("Error generating PDF: " + e.message));
}

function clearLocalStorage() {
  const confirmClear = confirm("Are you sure you want to delete ALL saved employee and week data?");
  
  if (confirmClear) {
    localStorage.removeItem(KEY);
    window.location.reload(); 
  }
}

// START THE APP
init(); 
</script>
</body>
</html>
